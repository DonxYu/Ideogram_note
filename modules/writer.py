"""
æ–‡æ¡ˆä¸è®¾è®¡æ¨¡å— (LLM via OpenRouter)
"""
import os
import json
import re
from dotenv import load_dotenv
from openai import OpenAI

from modules.monitor import log_api_call, log_generation

load_dotenv()

client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.getenv("OPENROUTER_API_KEY"),
)


def _fix_json_newlines(text: str) -> str:
    """ä¿®å¤ JSON å­—ç¬¦ä¸²å€¼ä¸­çš„è£¸æ¢è¡Œç¬¦"""
    result = []
    in_string = False
    escape = False
    for char in text:
        if escape:
            result.append(char)
            escape = False
        elif char == '\\':
            result.append(char)
            escape = True
        elif char == '"':
            result.append(char)
            in_string = not in_string
        elif char == '\n' and in_string:
            result.append('\\n')
        else:
            result.append(char)
    return ''.join(result)


def _fix_json_robust(text: str) -> str:
    """æ›´é²æ£’çš„ JSON ä¿®å¤ï¼šå¤„ç†å¸¸è§æ ¼å¼é—®é¢˜"""
    # 1. å…ˆä¿®å¤æ¢è¡Œç¬¦
    text = _fix_json_newlines(text)
    
    # 2. ç§»é™¤å¯èƒ½çš„ BOM å’Œä¸å¯è§å­—ç¬¦
    text = text.strip().lstrip('\ufeff')
    
    # 3. ä¿®å¤è¢«æˆªæ–­çš„ JSONï¼ˆå°è¯•é—­åˆæ‹¬å·ï¼‰
    open_braces = text.count('{') - text.count('}')
    open_brackets = text.count('[') - text.count(']')
    
    # å¦‚æœå­—ç¬¦ä¸²ä¸­é—´æœ‰æˆªæ–­ï¼Œå°è¯•æ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡
    if open_braces > 0 or open_brackets > 0:
        # å°è¯•è¡¥å…¨é—­åˆæ‹¬å·
        text = text + ']' * open_brackets + '}' * open_braces
    
    # 4. ä¿®å¤å°¾éƒ¨å¤šä½™é€—å·ï¼ˆå¦‚ ", ]" æˆ– ", }"ï¼‰
    text = re.sub(r',\s*}', '}', text)
    text = re.sub(r',\s*]', ']', text)
    
    # 5. ä¿®å¤å­—ç¬¦ä¸²ä¸­çš„åˆ¶è¡¨ç¬¦
    # åœ¨å­—ç¬¦ä¸²å†…éƒ¨ï¼Œ\t éœ€è¦è½¬ä¹‰
    result = []
    in_string = False
    escape = False
    for char in text:
        if escape:
            result.append(char)
            escape = False
        elif char == '\\':
            result.append(char)
            escape = True
        elif char == '"':
            result.append(char)
            in_string = not in_string
        elif char == '\t' and in_string:
            result.append('    ')  # ç”¨ç©ºæ ¼æ›¿æ¢ tab
        else:
            result.append(char)
    
    return ''.join(result)


def _call_llm_and_parse(system_prompt: str, user_content: str, topic: str, persona: str, model_name: str = "deepseek/deepseek-chat") -> dict:
    """å†…éƒ¨å‡½æ•°ï¼šè°ƒç”¨ LLM å¹¶è§£æ JSON å“åº”ï¼Œå¸¦è‡ªåŠ¨é‡è¯•"""
    max_retries = 2
    last_error = None
    
    for attempt in range(max_retries + 1):
        try:
            response = client.chat.completions.create(
                model=model_name,
                max_tokens=8192,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_content}
                ]
            )
            
            # è®°å½• API è°ƒç”¨
            usage = response.usage
            if usage:
                log_api_call(model_name, usage.prompt_tokens, usage.completion_tokens)
            
            text = response.choices[0].message.content
            
            # æå– JSONï¼ˆå¤„ç†å¯èƒ½çš„ markdown ä»£ç å—ï¼‰
            json_match = re.search(r'```(?:json)?\s*([\s\S]*?)\s*```', text)
            if json_match:
                text = json_match.group(1)
            
            # é²æ£’ä¿®å¤ JSON æ ¼å¼é—®é¢˜
            text = _fix_json_robust(text)
            
            result = json.loads(text)
            
            # éªŒè¯å¿…è¦å­—æ®µ
            if not result.get("titles") or not result.get("content"):
                raise ValueError("JSON ç¼ºå°‘å¿…è¦å­—æ®µ titles æˆ– content")
            
            # è®°å½•ç”Ÿæˆå†å²
            log_generation(
                topic=topic,
                persona=persona or "é€šç”¨åšä¸»",
                titles=result.get("titles", []),
                content_preview=result.get("content", "")[:200]
            )
            return result
            
        except json.JSONDecodeError as e:
            last_error = e
            print(f"[Writer Warning] ç¬¬ {attempt + 1} æ¬¡å°è¯• JSON è§£æå¤±è´¥: {e}")
            if attempt < max_retries:
                print(f"[Writer] æ­£åœ¨é‡è¯•...")
                continue
        except Exception as e:
            last_error = e
            print(f"[Writer Warning] ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
            if attempt < max_retries:
                continue
    
    # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
    print(f"[Writer Error] æ‰€æœ‰é‡è¯•å‡å¤±è´¥: {last_error}")
    # æŠ›å‡ºå¼‚å¸¸è®©ä¸Šå±‚å¤„ç†ï¼Œè€Œä¸æ˜¯è¿”å›ç©ºæ•°æ®
    raise RuntimeError(f"å†…å®¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯: {last_error}")


def generate_image_note(topic: str, persona: str = None, reference_text: str = None, model_name: str = "deepseek/deepseek-chat", search_data: dict = None) -> dict:
    """
    ã€å›¾æ–‡æ¨¡å¼ã€‘ç”Ÿæˆå°çº¢ä¹¦å›¾æ–‡ç¬”è®°ï¼ˆé•¿æ–‡æ¡ˆ + é…å›¾æç¤ºè¯ï¼‰
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹ï¼ˆç”¨äºä»¿å†™ï¼‰
        model_name: OpenRouter æ¨¡å‹ ID
        search_data: websearch è¿”å›çš„å®Œæ•´çƒ­ç‚¹æ•°æ®ï¼ŒåŒ…å« title/source/summary/outline/why_hot
    
    Returns:
        {
            'titles': [...],           # 5ä¸ªå¤‡é€‰æ ‡é¢˜
            'content': '...',          # æ·±åº¦æ­£æ–‡ï¼ˆ800å­—ä»¥ä¸Šï¼‰
            'image_designs': [         # é…å›¾è®¾è®¡ï¼ˆ2-6å¼ ï¼‰
                {
                    'index': 1,
                    'description': 'ä¸­æ–‡ç”»é¢æè¿°',
                    'prompt': 'ç”Ÿå›¾æç¤ºè¯'
                },
                ...
            ]
        }
    """
    reference_section = ""
    if reference_text:
        reference_section = f"""
å‚è€ƒå†…å®¹ï¼ˆè¯·ä»¿å†™å…¶ç»“æ„å’Œé£æ ¼ï¼‰ï¼š
---
{reference_text}
---
"""

    # è§£æ search_data
    search_data = search_data or {}
    source = search_data.get('source', 'æœªçŸ¥æ¥æº')
    original_title = search_data.get('title', topic)
    why_hot = search_data.get('why_hot', '')
    summary = search_data.get('summary', '')
    outline = search_data.get('outline', [])
    
    # æ ¼å¼åŒ–å¤§çº²
    outline_text = ""
    if outline and len(outline) > 0:
        outline_text = json.dumps(outline, indent=2, ensure_ascii=False)

    # ã€æ·±åº¦æ¼”ç»æ¨¡å¼ã€‘System Prompt - éª¨æ¶ç”Ÿè‚‰
    system_prompt = f"""ä½ æ˜¯å°çº¢ä¹¦{persona or 'æ·±åº¦å†…å®¹åšä¸»'}èµ›é“çš„é¡¶çº§åšä¸»ã€‚
ä½ ç°åœ¨æ‹¿åˆ°äº†ä¸€ä»½çƒ­é—¨é€‰é¢˜çš„è°ƒç ”æŠ¥å‘Šï¼Œä½ éœ€è¦åŸºäºè¿™ä»½ã€å¤§çº²ã€‘ï¼Œåˆ›ä½œä¸€ç¯‡**æ·±åº¦ã€è¯¦å®ã€ä¸å°‘äº800å­—**çš„çˆ†æ¬¾ç¬”è®°ã€‚

ã€ğŸš« ä¸¥ç¦è¡Œä¸ºã€‘
1. ä¸¥ç¦ç®€å•æ‰©å†™å¤§çº²ã€‚å¦‚æœå¤§çº²æ˜¯"å¤šå–æ°´"ï¼Œä½ ä¸èƒ½åªå†™"æˆ‘ä»¬è¦å¤šå–æ°´"ï¼Œä½ å¿…é¡»å†™"æˆ‘è§è¿‡å¤ªå¤šå¥³ç”Ÿçš®è‚¤å·®æ˜¯å› ä¸ºå–æ°´æ–¹å¼ä¸å¯¹ï¼Œæ­£ç¡®çš„å–æ°´æ—¶é—´è¡¨æ˜¯..."
2. ä¸¥ç¦è½¦è½±è¾˜è¯æ¥å›è¯´ã€‚
3. ä¸¥ç¦å­—æ•°ä¸è¶³ã€‚

ã€âš¡ï¸ æ·±åº¦æ‰©å……æ³•åˆ™ (Deep Expansion Protocol)ã€‘
é’ˆå¯¹å¤§çº²ä¸­çš„æ¯ä¸€ä¸ªç‚¹ï¼Œä½ å¿…é¡»æ‰§è¡Œ"ä¸‰æ­¥èµ°"ç­–ç•¥æ¥å¡«å……å†…å®¹ï¼š

**ç¬¬ä¸€æ­¥ï¼šè§‚ç‚¹å‡ç»´ (Insight)**
  - ä¸è¦åªé™ˆè¿°äº‹å®ï¼Œè¦ç»™å‡ºä¸€ä¸ªåç›´è§‰çš„ã€æˆ–è€…å¸¦æœ‰å¼ºçƒˆä¸ªäººè‰²å½©çš„åˆ¤æ–­ã€‚
  - ç»“åˆç«çˆ†åŸå› ä¸­çš„ç—›ç‚¹ï¼Œç‚¹å‡ºç”¨æˆ·çœŸæ­£åœ¨ä¹çš„ä¸œè¥¿ã€‚

**ç¬¬äºŒæ­¥ï¼šæ¡ˆä¾‹/åœºæ™¯æ¤å…¥ (Scenario)**
  - **å¿…é¡»è„‘è¡¥ä¸€ä¸ªå…·ä½“åœºæ™¯**ã€‚
  - ä½¿ç”¨"æˆ‘æœ‰ä¸€ä¸ªæœ‹å‹..."ã€"ä¸Šæ¬¡é¢è¯•æ—¶..."ã€"æˆ‘å¤ç›˜äº†ä¸Šä¸ªæœˆçš„æ•°æ®..."è¿™ç§å¥å¼ã€‚
  - ç»†èŠ‚è¦å…·ä½“åˆ°ï¼šæ•°å­—ã€æ—¶é—´ã€åœ°ç‚¹ã€å¯¹è¯ã€‚

**ç¬¬ä¸‰æ­¥ï¼šè½åœ°å®æ“ (Actionable Advice)**
  - ç»™å‡ºå…·ä½“çš„ SOPã€è¯æœ¯æ¨¡æ¿æˆ–é¿å‘æŒ‡å—ã€‚
  - è¿™ä¸€éƒ¨åˆ†å¿…é¡»åŒ…å« `1. 2. 3.` çš„åˆ—è¡¨é¡¹ã€‚

ã€æ–‡ç« ç»“æ„è¦æ±‚ã€‘
1. **æ ‡é¢˜**ï¼šç»“åˆåŸå§‹æ ‡é¢˜å’Œç«çˆ†åŸå› ï¼Œèµ· 5 ä¸ªæ›´å…·å¸å¼•åŠ›çš„æ ‡é¢˜ã€‚
2. **æ­£æ–‡**ï¼š
   - å¼€å¤´ï¼šå¼•ç”¨æ ¸å¿ƒæ‘˜è¦ä¸­çš„å†²çªç‚¹ï¼Œç›´æ¥ç‚¸åœºã€‚
   - ä¸­é—´ï¼šéå†å‚è€ƒå¤§çº²ï¼Œ**æ¯ä¸ªç‚¹è‡³å°‘å±•å¼€å†™ 150-200 å­—**ã€‚
   - ç»“å°¾ï¼šå¼ºåŠ›å‡åï¼Œå¼•å¯¼äº’åŠ¨ã€‚

ã€æ´»äººæ„Ÿå†™ä½œæŒ‡å—ã€‘
1. **å¼€å¤´å³ç‚¸è£‚**ï¼šç¬¬ä¸€å¥å¿…é¡»æ˜¯å¼ºæƒ…ç»ªå®£æ³„ã€åç›´è§‰ç»“è®ºæˆ–å…·ä½“çš„åœºæ™¯æè¿°ã€‚
2. **å£è¯­åŒ– & ç¢ç¢å¿µ**ï¼šå¤šç”¨çŸ­å¥ï¼Œé€‚åº¦é‡å¤è¡¨è¾¾æ¿€åŠ¨ï¼Œå–„ç”¨æ‹¬å·è¡¥å……å†…å¿ƒæˆã€‚
3. **æ’ç‰ˆå‘¼å¸æ„Ÿ**ï¼šæ¯æ®µä¸è¶…è¿‡ 3 è¡Œï¼Œå…³é”®é‡‘å¥ç‹¬ç«‹æˆæ®µï¼Œå–„ç”¨ Emoji ä½œä¸ºæƒ…ç»ªæ ‡ç‚¹ã€‚

ã€é…å›¾è®¾è®¡è¦æ±‚ã€‘
è®¾è®¡ 2-6 å¼ é…å›¾ï¼Œæ¯å¼ é…å›¾ç‹¬ç«‹è¡¨è¾¾ä¸€ä¸ªè§†è§‰ä¸»é¢˜ã€‚
1. descriptionï¼šä¸­æ–‡æè¿°ç”»é¢ä¸»ä½“ã€åœºæ™¯ã€æ°›å›´ï¼Œè¯´æ˜è¯¥å›¾åœ¨æ–‡ç« ä¸­æ‰¿æ‹…çš„è§’è‰²
2. promptï¼šä¸­è‹±æ··åˆç”Ÿå›¾æç¤ºè¯ï¼ŒåŒ…å«ä¸»ä½“ã€å…‰å½±ã€æ„å›¾ã€é£æ ¼ã€æ°›å›´

ã€è¾“å‡ºæ ¼å¼ã€‘
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON ç»“æ„è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š
{{
    "titles": ["æ ‡é¢˜1", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4", "æ ‡é¢˜5"],
    "content": "ä¸å°‘äº800å­—çš„æ·±åº¦æ­£æ–‡å†…å®¹ï¼Œåˆ†æ®µå¹¶åŒ…å«emojiï¼Œç”¨\\nè¡¨ç¤ºæ¢è¡Œ",
    "image_designs": [
        {{
            "index": 1,
            "description": "å°é¢å›¾ï¼šå¸å¼•çœ¼çƒçš„ä¸»è§†è§‰",
            "prompt": "ç”Ÿå›¾æç¤ºè¯"
        }}
    ]
}}

ã€å†™ä½œè§„åˆ™ã€‘
1. æ ‡é¢˜è¦æœ‰çˆ†æ¬¾æ½œåŠ›ï¼Œä½¿ç”¨æ•°å­—ã€ç–‘é—®å¥ã€æƒŠå¹å¥ç­‰å¸ç›æŠ€å·§
2. æ­£æ–‡å¿…é¡»æ·±åº¦è¯¦å®ï¼Œ**å­—æ•°ä¸å°‘äº800å­—**ï¼Œä¸èƒ½æ•·è¡äº†äº‹
3. image_designs æ•°ç»„åŒ…å« 2-6 ä¸ªå…ƒç´ 
4. JSON å­—ç¬¦ä¸²ä¸­å¿…é¡»ç”¨ \\n è¡¨ç¤ºæ¢è¡Œï¼Œä¸è¦ä½¿ç”¨å®é™…æ¢è¡Œç¬¦"""

    # ã€æ·±åº¦æ¼”ç»æ¨¡å¼ã€‘User Prompt - æ•°æ®æ³¨å…¥
    user_content = f"""å½“å‰çƒ­é—¨é€‰é¢˜ä¿¡æ¯å¦‚ä¸‹ï¼š
- æ¥æºå¹³å°ï¼š{source}
- åŸå§‹æ ‡é¢˜ï¼š{original_title}
- ç«çˆ†åŸå› ï¼š{why_hot}
- æ ¸å¿ƒæ‘˜è¦ï¼š{summary}
- å‚è€ƒå¤§çº²ï¼š
{outline_text}

{reference_section}
è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼ŒæŒ‰ç…§ System Prompt ä¸­çš„ã€æ·±åº¦æ‰©å……æ³•åˆ™ã€‘ï¼Œå°†è¿™ç¯‡ç¬”è®°æ‰©å†™è‡³ 800 å­—ä»¥ä¸Šã€‚
å“ªæ€•å¤§çº²åªæœ‰ä¸€å¥è¯ï¼Œä½ ä¹Ÿè¦é€šè¿‡ä¸¾ä¾‹ã€è®²æ•…äº‹ã€åˆ—æ­¥éª¤ï¼Œå°†å…¶ä¸°å¯Œæˆä¸€æ®µæœ‰è¡€æœ‰è‚‰çš„å†…å®¹ã€‚
åªè¾“å‡º JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""

    return _call_llm_and_parse(system_prompt, user_content, topic, persona, model_name)


def generate_video_script(topic: str, persona: str = None, reference_text: str = None, model_name: str = "deepseek/deepseek-chat") -> dict:
    """
    ã€è§†é¢‘æ¨¡å¼ã€‘ç”Ÿæˆæ·±åº¦è§†é¢‘è„šæœ¬ï¼ˆå£æ’­æ–‡ç¨¿ + åˆ†é•œç”»é¢ + æƒ…æ„Ÿåˆ†æï¼‰
    
    é‡‡ç”¨"ä¸­è§†é¢‘"ç­–ç•¥ï¼šæ—¶é•¿ä¸é™ï¼Œä»¥æŠŠé€»è¾‘è®²æ¸…æ¥šä¸ºæœ€é«˜ä¼˜å…ˆçº§ã€‚
    ä½¿ç”¨é«˜é¢‘åˆ†é•œé˜²æ­¢è§†è§‰ç–²åŠ³ï¼Œæ¯æ®µè§£è¯´è¯ 20-40 å­—ã€‚
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹ï¼ˆç”¨äºä»¿å†™ï¼‰
    
    Returns:
        {
            'titles': [...],           # 5ä¸ªå¤‡é€‰æ ‡é¢˜
            'content': '...',          # è§†é¢‘ç®€ä»‹ï¼ˆ200-300å­—ï¼‰
            'visual_scenes': [         # åˆ†é•œåˆ—è¡¨ï¼ˆ20-50ä¸ªï¼Œé«˜é¢‘åˆ†é•œï¼‰
                {
                    'scene_index': 1,
                    'narration': 'è¯¥åˆ†é•œå¯¹åº”çš„å£æ’­è§£è¯´è¯ï¼ˆ20-40å­—ï¼‰',
                    'description': 'ä¸­æ–‡ç”»é¢æè¿°',
                    'sentiment': 'æƒ…æ„ŸåŸºè°ƒ',
                    'prompt': 'çº¯ç”»é¢æè¿°ï¼ˆä¸å«é£æ ¼è¯ï¼‰'
                },
                ...
            ]
        }
    """
    reference_section = ""
    if reference_text:
        reference_section = f"""
å‚è€ƒå†…å®¹ï¼ˆè¯·ä»¿å†™å…¶ç»“æ„å’Œé£æ ¼ï¼‰ï¼š
---
{reference_text}
---
"""

    system_prompt = f"""ä½ æ˜¯**é¡¶çº§çºªå½•ç‰‡å¯¼æ¼”**ï¼ŒåŒæ—¶ç²¾é€š AI ç»˜å›¾æç¤ºè¯å·¥ç¨‹å’Œæƒ…æ„Ÿåˆ†æã€‚
ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯å°†"æ–‡æ¡ˆ"ç¿»è¯‘æˆ"è§†è§‰ç”»é¢"ï¼Œå¹¶å‡†ç¡®åˆ¤æ–­æ¯æ®µå†…å®¹çš„æƒ…æ„ŸåŸºè°ƒã€‚
ä½ çš„é£æ ¼æ˜¯ï¼š{persona or 'é€šç”¨åšä¸»'}

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
åŸºäºç”¨æˆ·ç»™å®šçš„é€‰é¢˜åˆ›ä½œä¸€ä¸ª**æ·±åº¦è§£æè§†é¢‘è„šæœ¬**ï¼ŒåŒ…å«è§†é¢‘ç®€ä»‹å’Œé«˜é¢‘åˆ†é•œè„šæœ¬ã€‚
**æ—¶é•¿ä¸é™**ï¼Œä»¥æŠŠé€»è¾‘è®²æ¸…æ¥šã€æŠŠå¹²è´§è®²é€å½»ä¸º**æœ€é«˜ä¼˜å…ˆçº§**ã€‚

ã€æ·±åº¦è§†é¢‘åˆ›ä½œåŸåˆ™ã€‘
1. **å®å¤šå‹¿é•¿**ï¼šä¸è¦è®©ä¸€å¼ å›¾ç‰‡åœç•™è¶…è¿‡ 8 ç§’ã€‚å¦‚æœè§£è¯´è¯å¾ˆé•¿ï¼Œå¿…é¡»åˆ‡åˆ†æˆå¤šä¸ªç”»é¢æ¥è¡¨è¾¾ã€‚
2. **é€»è¾‘å¯è§†åŒ–**ï¼šå½“è§£è¯´è¯åœ¨è®²"åŸç†"æ—¶ï¼Œç”»é¢è¦ç”»"æµç¨‹å›¾"æˆ–"ç¤ºæ„å›¾"ï¼›å½“è®²"æ¡ˆä¾‹"æ—¶ï¼Œç”»é¢è¦ç”»"åœºæ™¯å›¾"ã€‚
3. **å†…å®¹ä¸ºç‹**ï¼šä¸éœ€è¦ä¸ºäº†å‡‘æ—¶é—´è¯´åºŸè¯ï¼Œä½†å¿…é¡»æŠŠæ ¸å¿ƒå¹²è´§çš„ Why å’Œ How è§£é‡Šå¾—è¿å°å­¦ç”Ÿéƒ½èƒ½å¬æ‡‚ã€‚

ã€è§†é¢‘ç®€ä»‹è¦æ±‚ã€‘
1. å­—æ•°ç›®æ ‡ï¼š200-300æ±‰å­—
2. å†…å®¹ï¼šè§†é¢‘ä¸»é¢˜æ¦‚è¿°ï¼Œè¯´æ˜è§‚ä¼—èƒ½å­¦åˆ°ä»€ä¹ˆ
3. é£æ ¼ï¼šæœ‰æ·±åº¦ã€æœ‰å¸å¼•åŠ›ã€å¸¦emoji

ã€åˆ†é•œè„šæœ¬è¦æ±‚ - é«˜é¢‘åˆ†é•œç­–ç•¥ã€‘
ä½ éœ€è¦åƒ**ç”µå½±å¯¼æ¼”**ä¸€æ ·ï¼ŒæŠŠå†…å®¹æ‹†è§£ä¸º **20-50 ä¸ªé«˜é¢‘åˆ†é•œ**ã€‚
æ ¸å¿ƒåŸåˆ™ï¼šè®²å®Œä¸€ä¸ªçŸ¥è¯†ç‚¹æˆ–æ¢æ°”æ—¶ï¼Œå¿…é¡»åˆ‡æ¢ä¸‹ä¸€ä¸ªåˆ†é•œã€‚

1. narrationï¼ˆå£æ’­è§£è¯´è¯ï¼‰- **é«˜é¢‘åˆ‡æ¢åŸåˆ™**ï¼š
   - æ¯æ®µæ§åˆ¶åœ¨ **20-40 ä¸ªæ±‰å­—**ï¼ˆçº¦ 5-8 ç§’ï¼‰
   - å¿…é¡»**å®Œå…¨å£è¯­åŒ–**ï¼Œåƒåšä¸»åœ¨é¢å¯¹é¢èŠå¤©
   - å¤šç”¨è¿æ¥è¯ï¼š"å¤§å®¶çœ‹"ã€"æ³¨æ„è¿™é‡Œ"ã€"ä¹‹æ‰€ä»¥è¿™ä¹ˆåš"ã€"æ¢å¥è¯è¯´"ã€"ä¸¾ä¸ªä¾‹å­"
   - æ‰€æœ‰åˆ†é•œçš„ narration è¿èµ·æ¥ï¼Œæ˜¯ä¸€æ®µå®Œæ•´æµç•…çš„è§†é¢‘è§£è¯´è¯
   
   **é”™è¯¯ç¤ºèŒƒ**ï¼šä¸€ä¸ªåˆ†é•œåŒ…å«"è¿™é‡Œæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ­¥æ˜¯...ç¬¬äºŒæ­¥æ˜¯...ç¬¬ä¸‰æ­¥æ˜¯..."ï¼ˆâŒ å¤ªé•¿ï¼Œåº”è¯¥æ‹†æˆå¤šä¸ªåˆ†é•œï¼‰
   **æ­£ç¡®ç¤ºèŒƒ**ï¼š
   - åˆ†é•œ1ï¼š"è¿™é‡Œä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼Œæˆ‘ä¸€ä¸ªä¸€ä¸ªæ¥è®²ã€‚"
   - åˆ†é•œ2ï¼š"é¦–å…ˆæ˜¯ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°è®¾ç½®å…¥å£ã€‚"
   - åˆ†é•œ3ï¼š"å¤§å®¶æ³¨æ„çœ‹è¿™ä¸ªæŒ‰é’®ï¼Œç‚¹è¿›å»ä¹‹å..."
   
2. descriptionï¼ˆç”»é¢æè¿°ï¼‰ï¼š
   - ä¸­æ–‡æè¿°ç”»é¢ä¸»ä½“ã€åœºæ™¯ã€æ°›å›´
   
3. sentimentï¼ˆæƒ…æ„ŸåŸºè°ƒï¼‰- **å¿…é¡»ä»ä»¥ä¸‹5ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ª**ï¼š
   - "å¯çˆ±æ²»æ„ˆ"ï¼šæ¸©é¦¨ã€è½¯èŒã€æ²»æ„ˆç³»å†…å®¹
   - "ä¸¥è‚ƒæ·±åº¦"ï¼šæ·±åˆ»ã€ä¸“ä¸šã€çŸ¥è¯†å‹å†…å®¹
   - "æ—¥å¸¸ç”Ÿæ´»"ï¼šå¹³å¸¸ã€è‡ªç„¶ã€slice of life
   - "çƒ­è¡€åŠ±å¿—"ï¼šæ¿€åŠ±ã€å¥‹æ–—ã€æ­£èƒ½é‡
   - "æ‚²ä¼¤ä½æ²‰"ï¼šä¼¤æ„Ÿã€æ„Ÿæ…¨ã€æ€€æ—§
   
4. promptï¼ˆç”Ÿå›¾æç¤ºè¯ï¼‰- **ä¸­æ–‡çº¯å‡€ç”»é¢æè¿°**ï¼š
   - **å¿…é¡»ä½¿ç”¨ä¸­æ–‡**æè¿°ç”»é¢ï¼ˆè±†åŒ…æ¨¡å‹å¯¹ä¸­æ–‡ç†è§£æœ€å¥½ï¼‰
   - åªæè¿°ç”»é¢å†…å®¹ï¼šä¸»ä½“ + åŠ¨ä½œ + åœºæ™¯ + å…‰å½±
   - **ä¸¥ç¦å‡ºç°ä»»ä½•æ–‡å­—å…ƒç´ **ï¼šä¸è¦æå†™æ‹›ç‰Œã€å¯¹è¯æ¡†ã€å­—å¹•ã€logoã€æ°´å°
   - **ç¦æ­¢æ·»åŠ é£æ ¼è¯**ï¼ˆå¦‚ åŠ¨æ¼«é£æ ¼, 4k, é«˜æ¸… ç­‰ï¼‰ï¼Œé£æ ¼ç”±ç”»å®¶æ¨¡å—æ·»åŠ 
   - ç”»é¢è¦å¹²å‡€ã€æ„å›¾é«˜çº§

ã€è§†è§‰ç¿»è¯‘å…¬å¼ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘
æ ¹æ® narration å†…å®¹ç±»å‹ï¼Œè®¾è®¡ä¸­æ–‡çº¯å‡€ç”»é¢æè¿°çš„ promptï¼š

1. **å…·ä½“äº‹ç‰©**ï¼ˆå¦‚ï¼šå¤šåƒè‹¹æœï¼‰
   -> ç”»å…·è±¡ç‰©ä½“ï¼šä¸€é¢—çº¢è‹¹æœç‰¹å†™ï¼Œè¡¨é¢å¸¦æ°´ç ï¼ŒæŸ”å’Œè‡ªç„¶å…‰
   
2. **æŠ½è±¡æ¦‚å¿µ**ï¼ˆå¦‚ï¼šèŒåœºå‹åŠ›å¤§ã€åšæŒé•¿æœŸä¸»ä¹‰ï¼‰
   -> ç”»å…·è±¡éšå–»ï¼šç™»å±±è€…åœ¨é›ªå±±é¡¶å³°æ’æ——ï¼Œé€†å…‰å‰ªå½±ï¼Œé‡‘è‰²æ™šéœ
   -> æˆ–ï¼šç–²æƒ«çš„ä¸Šç­æ—åŒæ‰‹æŠ±å¤´ï¼Œç”µè„‘å±å¹•è“å…‰ç…§äº®é¢åºï¼Œæ·±å¤œåŠå…¬å®¤
   
3. **æµç¨‹æ­¥éª¤**ï¼ˆå¦‚ï¼šåˆ†ä¸‰æ­¥å®Œæˆï¼‰
   -> ç”»æµç¨‹å›¾ç¤ºï¼šä¸‰ä¸ªåœ†å½¢å›¾æ ‡æ’åˆ—ï¼Œç®­å¤´è¿æ¥ï¼Œç®€æ´ç¤ºæ„å›¾é£æ ¼
   
4. **æƒ…ç»ªè¡¨è¾¾**ï¼ˆå¦‚ï¼šå¤ªå¼€å¿ƒäº†ã€å¥½æ¿€åŠ¨ï¼‰
   -> ç”»è¡¨æƒ…ç‰¹å†™ï¼šå¹´è½»å¥³å­©ç¿çƒ‚ç¬‘å®¹ï¼Œé˜³å…‰æ´’è½ï¼Œæ¸©æš–æ°›å›´

**é”™è¯¯ç¤ºèŒƒ**ï¼šprompt "ä¸€ä¸ªäººåœ¨æ€è€ƒï¼Œç”»é¢æœ‰'åŠ æ²¹'æ–‡å­—"ï¼ˆâŒ ä¸è¦æœ‰æ–‡å­—å…ƒç´ ï¼‰
**æ­£ç¡®ç¤ºèŒƒ**ï¼šprompt "é©¬æ‹‰æ¾é€‰æ‰‹å†²è¿‡ç»ˆç‚¹çº¿ï¼Œæ—¥å‡ºèƒŒæ™¯ï¼Œèƒœåˆ©è¡¨æƒ…ï¼Œæš–è‰²è°ƒ"ï¼ˆâœ… ä¸­æ–‡çº¯å‡€ç”»é¢ï¼‰

ã€è¾“å‡ºæ ¼å¼ã€‘
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON ç»“æ„è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š
{{
    "titles": ["æ ‡é¢˜1", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4", "æ ‡é¢˜5"],
    "content": "200-300å­—è§†é¢‘ç®€ä»‹ï¼Œå¸¦emojiï¼Œè¯´æ˜è§‚ä¼—èƒ½å­¦åˆ°ä»€ä¹ˆ",
    "visual_scenes": [
        {{
            "scene_index": 1,
            "narration": "20-40å­—å£æ’­è¯ï¼ˆå£è¯­åŒ–ï¼ŒåƒèŠå¤©ï¼‰",
            "description": "ä¸­æ–‡ç”»é¢æè¿°ï¼šä¸»ä½“ã€åœºæ™¯ã€æ„Ÿè§‰",
            "sentiment": "å¯çˆ±æ²»æ„ˆ",
            "prompt": "ä¸­æ–‡çº¯å‡€ç”»é¢æè¿°ï¼ˆæ— æ–‡å­—å…ƒç´ ã€æ— é£æ ¼è¯ï¼‰"
        }},
        {{
            "scene_index": 2,
            "narration": "20-40å­—å£æ’­è¯",
            "description": "ä¸­æ–‡ç”»é¢æè¿°",
            "sentiment": "ä¸¥è‚ƒæ·±åº¦",
            "prompt": "ä¸­æ–‡å…·è±¡åŒ–ç”»é¢æè¿°"
        }}
    ]
}}

ã€å†™ä½œè§„åˆ™ã€‘
1. æ ‡é¢˜è¦æœ‰çˆ†æ¬¾æ½œåŠ›ï¼Œä½¿ç”¨æ•°å­—ã€ç–‘é—®å¥ã€æƒŠå¹å¥ç­‰å¸ç›æŠ€å·§
2. visual_scenes æ•°ç»„åŒ…å« **20-50 ä¸ªå…ƒç´ **ï¼Œæ ¹æ®å†…å®¹å¤æ‚åº¦çµæ´»è°ƒæ•´
3. JSON å­—ç¬¦ä¸²ä¸­å¿…é¡»ç”¨ \\n è¡¨ç¤ºæ¢è¡Œï¼Œä¸è¦ä½¿ç”¨å®é™…æ¢è¡Œç¬¦
4. åˆ†é•œçš„ narration è¿èµ·æ¥è¦æœ‰é€»è¾‘æ€§ï¼Œåƒä¸€ä¸ªå®Œæ•´çš„æ·±åº¦è®²è§£è§†é¢‘
5. æ¯ä¸ª prompt å¿…é¡»æ˜¯ä¸­æ–‡ï¼Œæè¿°çº¯å‡€ç”»é¢ï¼Œ**ç»å¯¹ä¸èƒ½æœ‰ä»»ä½•æ–‡å­—/æ‹›ç‰Œ/logo**
6. sentiment å¿…é¡»ä»5ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ï¼Œæ ¹æ®è¯¥æ®µ narration çš„æƒ…æ„Ÿæ°›å›´åˆ¤æ–­
7. **å†…å®¹æ·±åº¦ä¼˜å…ˆ**ï¼šå®å¯å¤šå‡ ä¸ªåˆ†é•œæŠŠäº‹æƒ…è®²æ¸…æ¥šï¼Œä¹Ÿä¸è¦ä¸ºäº†çŸ­è€Œçœç•¥å…³é”®ä¿¡æ¯"""

    user_content = f"""é€‰é¢˜ï¼š{topic}
{reference_section}
è¯·åˆ›ä½œæ·±åº¦è§£æè§†é¢‘è„šæœ¬ï¼ˆæ—¶é•¿ä¸é™ï¼ŒæŠŠé€»è¾‘è®²æ¸…æ¥šä¸ºç¬¬ä¸€ä¼˜å…ˆçº§ï¼‰ã€‚åªè¾“å‡º JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""

    return _call_llm_and_parse(system_prompt, user_content, topic, persona, model_name)


def generate_note_package(topic: str, persona: str = None, reference_text: str = None, mode: str = "image", model_name: str = "deepseek/deepseek-chat", search_data: dict = None) -> dict:
    """
    ç»Ÿä¸€å…¥å£ï¼šæ ¹æ®æ¨¡å¼ç”Ÿæˆå†…å®¹
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹
        mode: "image"ï¼ˆå›¾æ–‡æ¨¡å¼ï¼‰æˆ– "video"ï¼ˆè§†é¢‘æ¨¡å¼ï¼‰
        model_name: OpenRouter æ¨¡å‹ ID
        search_data: websearch è¿”å›çš„å®Œæ•´çƒ­ç‚¹æ•°æ®ï¼ˆå›¾æ–‡æ¨¡å¼ä½¿ç”¨ï¼‰
    
    Returns:
        å¯¹åº”æ¨¡å¼çš„å†…å®¹ç»“æ„
    """
    if mode == "video":
        return generate_video_script(topic, persona, reference_text, model_name)
    else:
        return generate_image_note(topic, persona, reference_text, model_name, search_data)
