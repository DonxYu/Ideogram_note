"""
æ–‡æ¡ˆä¸è®¾è®¡æ¨¡å— (LLM via OpenRouter)
"""
import os
import json
import re
from pathlib import Path
from dotenv import load_dotenv
from openai import OpenAI

from modules.monitor import log_api_call, log_generation
from modules.quality_checker import check_content_quality, format_quality_report

# åŠ è½½é¡¹ç›®æ ¹ç›®å½•çš„ .env æ–‡ä»¶
_project_root = Path(__file__).parent.parent
load_dotenv(_project_root / ".env")

client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.getenv("OPENROUTER_API_KEY"),
)


def _fix_json_newlines(text: str) -> str:
    """ä¿®å¤ JSON å­—ç¬¦ä¸²å€¼ä¸­çš„è£¸æ¢è¡Œç¬¦ï¼ˆç®€åŒ–ç‰ˆï¼ŒåŒå¼•å·ç”± Prompt æ§åˆ¶ï¼‰"""
    result = []
    in_string = False
    escape = False
    for char in text:
        if escape:
            result.append(char)
            escape = False
        elif char == '\\':
            result.append(char)
            escape = True
        elif char == '"':
            result.append(char)
            in_string = not in_string
        elif char == '\n' and in_string:
            result.append('\\n')
        else:
            result.append(char)
    return ''.join(result)


def _call_llm_and_parse(system_prompt: str, user_content: str, topic: str, persona: str, model_name: str = "deepseek/deepseek-chat", temperature: float = 0.8) -> dict:
    """å†…éƒ¨å‡½æ•°ï¼šè°ƒç”¨ LLM å¹¶è§£æ JSON å“åº”"""
    response = client.chat.completions.create(
        model=model_name,
        max_tokens=8192,
        temperature=temperature,
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_content}
        ]
    )
    
    # è®°å½• API è°ƒç”¨
    usage = response.usage
    if usage:
        log_api_call(model_name, usage.prompt_tokens, usage.completion_tokens)
    
    text = response.choices[0].message.content
    
    # æå– JSONï¼ˆå¤„ç†å¯èƒ½çš„ markdown ä»£ç å—ï¼‰
    json_match = re.search(r'```(?:json)?\s*([\s\S]*?)\s*```', text)
    if json_match:
        text = json_match.group(1)
    
    # ç§»é™¤æ‰€æœ‰ä»£ç å—ï¼ˆå¦‚æœ LLM è¯¯è¾“å‡ºäº†ä»£ç ï¼‰
    # ä¿ç•™ JSON å¯¹è±¡éƒ¨åˆ†ï¼ˆä»¥ { å¼€å¤´ï¼‰
    if not text.strip().startswith('{'):
        # å°è¯•æ‰¾åˆ°ç¬¬ä¸€ä¸ª { å¼€å§‹çš„ JSON
        json_obj_match = re.search(r'\{[\s\S]*\}', text)
        if json_obj_match:
            text = json_obj_match.group(0)
    
    # å…œåº•ï¼šä¿®å¤å¯èƒ½å­˜åœ¨çš„è£¸æ¢è¡Œç¬¦
    text = _fix_json_newlines(text)
    
    try:
        result = json.loads(text)
        # è®°å½•ç”Ÿæˆå†å²
        log_generation(
            topic=topic,
            persona=persona or "é€šç”¨åšä¸»",
            titles=result.get("titles", []),
            content_preview=result.get("content", "")[:200]
        )
        return result
    except json.JSONDecodeError as e:
        print(f"\n{'='*60}")
        print(f"[Writer Error] JSON è§£æå¤±è´¥")
        print(f"{'='*60}")
        print(f"é”™è¯¯è¯¦æƒ…: {e}")
        print(f"é”™è¯¯ä½ç½®: ç¬¬ {e.lineno} è¡Œï¼Œç¬¬ {e.colno} åˆ—")
        print(f"\nå®Œæ•´å“åº”å†…å®¹ï¼ˆå‰500å­—ç¬¦ï¼‰:")
        print(f"{text[:500]}")
        print(f"\nå®Œæ•´å“åº”å†…å®¹ï¼ˆå200å­—ç¬¦ï¼‰:")
        print(f"{text[-200:]}")
        print(f"\nå“åº”æ€»é•¿åº¦: {len(text)} å­—ç¬¦")
        print(f"{'='*60}\n")
        # æŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯è¿”å›ç©ºæ•°æ®
        raise ValueError(f"LLM è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚é¢„è§ˆ: {text[:200]}")


def generate_image_note(topic: str, persona: str = None, reference_text: str = None, model_name: str = "deepseek/deepseek-chat", search_data: dict = None, temperature: float = 0.8) -> dict:
    """
    ã€å›¾æ–‡æ¨¡å¼ã€‘ç”Ÿæˆå°çº¢ä¹¦å›¾æ–‡ç¬”è®°ï¼ˆé•¿æ–‡æ¡ˆ + é…å›¾æç¤ºè¯ï¼‰
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹ï¼ˆç”¨äºä»¿å†™ï¼‰
        model_name: OpenRouter æ¨¡å‹ ID
        search_data: websearch è¿”å›çš„å®Œæ•´çƒ­ç‚¹æ•°æ®ï¼ŒåŒ…å« title/source/summary/outline/why_hot
    
    Returns:
        {
            'titles': [...],           # 5ä¸ªå¤‡é€‰æ ‡é¢˜
            'content': '...',          # æ·±åº¦æ­£æ–‡ï¼ˆ800å­—ä»¥ä¸Šï¼‰
            'image_designs': [         # é…å›¾è®¾è®¡ï¼ˆ2-6å¼ ï¼‰
                {
                    'index': 1,
                    'description': 'ä¸­æ–‡ç”»é¢æè¿°',
                    'prompt': 'ç”Ÿå›¾æç¤ºè¯'
                },
                ...
            ]
        }
    """
    reference_section = ""
    if reference_text:
        reference_section = f"""
å‚è€ƒå†…å®¹ï¼ˆè¯·ä»¿å†™å…¶ç»“æ„å’Œé£æ ¼ï¼‰ï¼š
---
{reference_text}
---
"""

    # è§£æ search_data
    search_data = search_data or {}
    source = search_data.get('source', 'æœªçŸ¥æ¥æº')
    original_title = search_data.get('title', topic)
    why_hot = search_data.get('why_hot', '')
    summary = search_data.get('summary', '')
    outline = search_data.get('outline', [])
    
    # æ ¼å¼åŒ–å¤§çº²
    outline_text = ""
    if outline and len(outline) > 0:
        outline_text = json.dumps(outline, indent=2, ensure_ascii=False)

    # ã€æ·±åº¦æ¼”ç»æ¨¡å¼ã€‘System Prompt - éª¨æ¶ç”Ÿè‚‰
    system_prompt = f"""ä½ æ˜¯å°çº¢ä¹¦{persona or 'æ·±åº¦å†…å®¹åšä¸»'}èµ›é“çš„é¡¶çº§åšä¸»ã€‚
ä½ ç°åœ¨æ‹¿åˆ°äº†ä¸€ä»½çƒ­é—¨é€‰é¢˜çš„è°ƒç ”æŠ¥å‘Šï¼Œä½ éœ€è¦åŸºäºè¿™ä»½ã€å¤§çº²ã€‘ï¼Œåˆ›ä½œä¸€ç¯‡**æ·±åº¦ã€è¯¦å®ã€ä¸å°‘äº800å­—**çš„çˆ†æ¬¾ç¬”è®°ã€‚

ã€ğŸš« ä¸¥ç¦è¡Œä¸ºã€‘
1. ä¸¥ç¦ç®€å•æ‰©å†™å¤§çº²ã€‚å¦‚æœå¤§çº²æ˜¯"å¤šå–æ°´"ï¼Œä½ ä¸èƒ½åªå†™"æˆ‘ä»¬è¦å¤šå–æ°´"ï¼Œä½ å¿…é¡»å†™"æˆ‘è§è¿‡å¤ªå¤šå¥³ç”Ÿçš®è‚¤å·®æ˜¯å› ä¸ºå–æ°´æ–¹å¼ä¸å¯¹ï¼Œæ­£ç¡®çš„å–æ°´æ—¶é—´è¡¨æ˜¯..."
2. ä¸¥ç¦è½¦è½±è¾˜è¯æ¥å›è¯´ã€‚
3. ä¸¥ç¦å­—æ•°ä¸è¶³ã€‚

ã€âš¡ï¸ æ·±åº¦æ‰©å……æ³•åˆ™ (Deep Expansion Protocol)ã€‘
é’ˆå¯¹å¤§çº²ä¸­çš„æ¯ä¸€ä¸ªç‚¹ï¼Œä½ å¿…é¡»æ‰§è¡Œ"ä¸‰æ­¥èµ°"ç­–ç•¥æ¥å¡«å……å†…å®¹ï¼š

**ç¬¬ä¸€æ­¥ï¼šè§‚ç‚¹å‡ç»´ (Insight)**
  - ä¸è¦åªé™ˆè¿°äº‹å®ï¼Œè¦ç»™å‡ºä¸€ä¸ªåç›´è§‰çš„ã€æˆ–è€…å¸¦æœ‰å¼ºçƒˆä¸ªäººè‰²å½©çš„åˆ¤æ–­ã€‚
  - ç»“åˆç«çˆ†åŸå› ä¸­çš„ç—›ç‚¹ï¼Œç‚¹å‡ºç”¨æˆ·çœŸæ­£åœ¨ä¹çš„ä¸œè¥¿ã€‚

**ç¬¬äºŒæ­¥ï¼šæ¡ˆä¾‹/åœºæ™¯æ¤å…¥ (Scenario)**
  - **å¿…é¡»è„‘è¡¥ä¸€ä¸ªå…·ä½“åœºæ™¯**ã€‚
  - ä½¿ç”¨"æˆ‘æœ‰ä¸€ä¸ªæœ‹å‹..."ã€"ä¸Šæ¬¡é¢è¯•æ—¶..."ã€"æˆ‘å¤ç›˜äº†ä¸Šä¸ªæœˆçš„æ•°æ®..."è¿™ç§å¥å¼ã€‚
  - ç»†èŠ‚è¦å…·ä½“åˆ°ï¼šæ•°å­—ã€æ—¶é—´ã€åœ°ç‚¹ã€å¯¹è¯ã€‚

**ç¬¬ä¸‰æ­¥ï¼šè½åœ°å®æ“ (Actionable Advice)**
  - ç»™å‡ºå…·ä½“çš„ SOPã€è¯æœ¯æ¨¡æ¿æˆ–é¿å‘æŒ‡å—ã€‚
  - è¿™ä¸€éƒ¨åˆ†å¿…é¡»åŒ…å« `1. 2. 3.` çš„åˆ—è¡¨é¡¹ã€‚

ã€æ–‡ç« ç»“æ„è¦æ±‚ã€‘
1. **æ ‡é¢˜**ï¼šç»“åˆåŸå§‹æ ‡é¢˜å’Œç«çˆ†åŸå› ï¼Œèµ· 5 ä¸ªæ›´å…·å¸å¼•åŠ›çš„æ ‡é¢˜ã€‚
2. **æ­£æ–‡**ï¼š
   - å¼€å¤´ï¼šå¼•ç”¨æ ¸å¿ƒæ‘˜è¦ä¸­çš„å†²çªç‚¹ï¼Œç›´æ¥ç‚¸åœºã€‚
   - ä¸­é—´ï¼šéå†å‚è€ƒå¤§çº²ï¼Œ**æ¯ä¸ªç‚¹è‡³å°‘å±•å¼€å†™ 150-200 å­—**ã€‚
   - ç»“å°¾ï¼šå¼ºåŠ›å‡åï¼Œå¼•å¯¼äº’åŠ¨ã€‚

ã€æ´»äººæ„Ÿå†™ä½œæŒ‡å—ã€‘
1. **å¼€å¤´å³ç‚¸è£‚**ï¼šç¬¬ä¸€å¥å¿…é¡»æ˜¯å¼ºæƒ…ç»ªå®£æ³„ã€åç›´è§‰ç»“è®ºæˆ–å…·ä½“çš„åœºæ™¯æè¿°ã€‚
2. **å£è¯­åŒ– & ç¢ç¢å¿µ**ï¼šå¤šç”¨çŸ­å¥ï¼Œé€‚åº¦é‡å¤è¡¨è¾¾æ¿€åŠ¨ï¼Œå–„ç”¨æ‹¬å·è¡¥å……å†…å¿ƒæˆã€‚
3. **æ’ç‰ˆå‘¼å¸æ„Ÿ**ï¼šæ¯æ®µä¸è¶…è¿‡ 3 è¡Œï¼Œå…³é”®é‡‘å¥ç‹¬ç«‹æˆæ®µï¼Œå–„ç”¨ Emoji ä½œä¸ºæƒ…ç»ªæ ‡ç‚¹ã€‚

ã€ä¸¥ç¦ AI å‘³å¥—è¯ - è´¨é‡çº¢çº¿ã€‘
ä»¥ä¸‹è¡¨è¾¾ä¸€æ—¦å‡ºç°ç«‹å³åˆ¤å®šä¸ºä¸åˆæ ¼ï¼š
- "ä¼—æ‰€å‘¨çŸ¥"ã€"ä¸å¾—ä¸è¯´"ã€"å¯ä»¥è¯´æ˜¯"ã€"å€¼å¾—ä¸€æçš„æ˜¯"
- "åœ¨...æ–¹é¢"ã€"è¿›è¡Œ...æ“ä½œ"ã€"ç›¸å…³çš„..."
- ç©ºæ´æ€»ç»“ï¼š"æ€»è€Œè¨€ä¹‹"ã€"ç»¼ä¸Šæ‰€è¿°"ã€"ç”±æ­¤å¯è§"
- æ²¡æœ‰å…·ä½“æ•°å­—å’Œæ—¶é—´çš„æ³›åŒ–æè¿°ï¼ˆ"å¾ˆå¤š"ã€"å¤§é‡"ã€"ç»å¸¸"ï¼‰
- æœºæ¢°å¼åˆ—ä¸¾ï¼š"é¦–å…ˆ...å…¶æ¬¡...æœ€å..."ï¼ˆå¿…é¡»ç”¨å£è¯­åŒ–è¿æ¥ï¼‰

ã€çœŸå®åšä¸»è‡ªæ£€æ¸…å• - å¿…é¡»å…¨éƒ¨æ»¡è¶³ã€‘
âœ“ è‡³å°‘ 2 å¤„å…·ä½“æ•°å­—ï¼ˆå¦‚ï¼šæ¶¨ç²‰ 3000ã€è¿ç»­ 15 å¤©ã€èŠ±äº† 2 å°æ—¶ï¼‰
âœ“ è‡³å°‘ 1 å¤„ä¸ªäººç»å†ï¼ˆæˆ‘/æˆ‘æœ‹å‹/æˆ‘åŒäº‹çš„çœŸå®æ•…äº‹ï¼‰
âœ“ è‡³å°‘ 3 å¤„å¼ºæƒ…ç»ªè¯ï¼ˆç»äº†/å¤ªçˆ±äº†/å´©æºƒ/yyds/æ•‘å‘½ï¼‰
âœ“ å¯¹è¯æˆ–å†…å¿ƒç‹¬ç™½è‡³å°‘ 1 æ¬¡ï¼ˆ"æˆ‘å½“æ—¶å°±æƒ³..."ã€"è€æ¿è¯´..."ï¼‰
âœ“ è‡³å°‘ 1 å¤„åé—®æˆ–è‡ªé—®è‡ªç­”ï¼ˆ"ä½ çŸ¥é“ä¸ºä»€ä¹ˆå—ï¼Ÿ"ã€"æ˜¯ä¸æ˜¯å¾ˆç¦»è°±ï¼Ÿ"ï¼‰

ã€é…å›¾è®¾è®¡è¦æ±‚ã€‘
è®¾è®¡ 2-6 å¼ é…å›¾ï¼Œæ¯å¼ é…å›¾ç‹¬ç«‹è¡¨è¾¾ä¸€ä¸ªè§†è§‰ä¸»é¢˜ã€‚

**ç©¿æ­é£æ ¼è¦æ±‚**ï¼ˆèŒåœºä¸»é¢˜ï¼‰ï¼š
- âœ“ æ¨èï¼šé’ˆç»‡è¡«ã€è¡¬è¡«ã€Tæ¤ã€ç‰›ä»”è£¤ã€åŠèº«è£™ã€ä¼‘é—²å¤–å¥—
- âœ— é¿å…ï¼šæ­£å¼è¥¿è£…ã€èŒä¸šå¥—è£…ã€é¢†å¸¦ã€é«˜è·Ÿé‹

**èƒŒæ™¯åœºæ™¯è¦æ±‚**ï¼ˆèŒåœºä¸»é¢˜ï¼‰ï¼š
- âœ“ æ¨èï¼šç°ä»£åŠå…¬å®¤ï¼ˆå¼€æ”¾å¼ï¼‰ã€å’–å•¡å…ã€ä¼‘æ¯åŒºã€ä¼šè®®å®¤ã€çª—è¾¹
- âœ“ è¦æ±‚ï¼šçœŸå®æ„Ÿåœºæ™¯ï¼Œè‡ªç„¶å…‰ç…§ï¼Œç”Ÿæ´»åŒ–æ°›å›´
- âœ— é¿å…ï¼šè¿‡äºæ­£å¼çš„ä¼šè®®å®¤ã€ä¼ ç»ŸåŠå…¬æ¡Œ

**å›¾ç‰‡ç”Ÿæˆå­—æ®µè¦æ±‚**ï¼š
1. descriptionï¼šä¸­æ–‡æè¿°ç”»é¢ä¸»ä½“ã€ç©¿æ­ã€åœºæ™¯ã€æ°›å›´ï¼Œè¯´æ˜è¯¥å›¾åœ¨æ–‡ç« ä¸­æ‰¿æ‹…çš„è§’è‰²
2. sentimentï¼šå›¾ç‰‡é£æ ¼æƒ…æ„Ÿï¼ŒèŒåœºä¸»é¢˜å»ºè®®ä½¿ç”¨"èŒåœºæ—¥å¸¸"
3. promptï¼šç”Ÿå›¾æç¤ºè¯ï¼Œå¿…é¡»åŒ…å«ï¼š
   - äººç‰©ï¼šäºŒæ¬¡å…ƒå¥³æ€§è§’è‰²
   - ç©¿æ­ï¼šå…·ä½“æè¿°ï¼ˆå¦‚"wearing casual cardigan and jeans"ï¼‰
   - èƒŒæ™¯ï¼šå…·ä½“åœºæ™¯ï¼ˆå¦‚"modern office with large windows"ï¼‰
   - å…‰ç…§ï¼šnatural lighting
4. cover_textï¼ˆä»…ç¬¬ä¸€å¼ ä¸»å›¾éœ€è¦ï¼‰ï¼š3-8ä¸ªæ±‰å­—çš„æ ¸å¿ƒæ–‡æ¡ˆï¼Œç”¨äºå åŠ æ˜¾ç¤º
   - è¦æ±‚ï¼šæç‚¼æ–‡ç« æ ¸å¿ƒè§‚ç‚¹æˆ–æœ€å¸ç›çš„ä¸€å¥è¯
   - ç¤ºä¾‹ï¼š"èŒåœºç©¿æ­è‡ªç”±"ã€"æ‹’ç»å†…è€—"ã€"å¹´ç»ˆå¥–æ”»ç•¥"

ã€è¾“å‡ºæ ¼å¼ã€‘
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON ç»“æ„è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š

**é‡è¦**ï¼šå¯¹è¯å’Œå¼•ç”¨å¿…é¡»ä½¿ç”¨ä¸­æ–‡å¼•å·ã€Œã€ï¼Œç¦æ­¢ä½¿ç”¨è‹±æ–‡åŒå¼•å· "
ç¤ºä¾‹ï¼šâŒ "è€æ¿è¯´ï¼š"åŠ æ²¹""  âœ… "è€æ¿è¯´ï¼šã€ŒåŠ æ²¹ã€"

{{
    "titles": ["æ ‡é¢˜1", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4", "æ ‡é¢˜5"],
    "content": "ä¸å°‘äº800å­—çš„æ·±åº¦æ­£æ–‡å†…å®¹ï¼Œåˆ†æ®µå¹¶åŒ…å«emojiï¼Œç”¨\\nè¡¨ç¤ºæ¢è¡Œï¼Œå¯¹è¯ç”¨ä¸­æ–‡å¼•å·ã€Œã€",
    "image_designs": [
        {{
            "index": 1,
            "description": "å°é¢å›¾ï¼šèŒåœºå¥³æ€§è§’è‰²ï¼Œç©¿ä¼‘é—²é’ˆç»‡è¡«å’Œç‰›ä»”è£¤ï¼Œç«™åœ¨ç°ä»£åŠå…¬å®¤çª—è¾¹",
            "sentiment": "èŒåœºæ—¥å¸¸",
            "prompt": "anime style office girl wearing casual cardigan and jeans, modern office background with large windows, natural lighting",
            "cover_text": "èŒåœºç©¿æ­è‡ªç”±"
        }},
        {{
            "index": 2,
            "description": "é…å›¾æè¿°",
            "sentiment": "èŒåœºæ—¥å¸¸",
            "prompt": "é…å›¾æç¤ºè¯"
        }}
    ]
}}

ã€å†™ä½œè§„åˆ™ã€‘
1. æ ‡é¢˜è¦æœ‰çˆ†æ¬¾æ½œåŠ›ï¼Œä½¿ç”¨æ•°å­—ã€ç–‘é—®å¥ã€æƒŠå¹å¥ç­‰å¸ç›æŠ€å·§
2. æ­£æ–‡å¿…é¡»æ·±åº¦è¯¦å®ï¼Œ**å­—æ•°ä¸å°‘äº800å­—**ï¼Œä¸èƒ½æ•·è¡äº†äº‹
3. image_designs æ•°ç»„åŒ…å« 2-6 ä¸ªå…ƒç´ 
4. **ç¬¬ä¸€å¼ å›¾ç‰‡ï¼ˆä¸»å›¾ï¼‰å¿…é¡»åŒ…å« cover_text å­—æ®µ**ï¼š3-8ä¸ªæ±‰å­—çš„æ ¸å¿ƒæ–‡æ¡ˆ
5. é…å›¾ï¼ˆç¬¬2-6å¼ ï¼‰ä¸éœ€è¦ cover_text å­—æ®µ
6. JSON å­—ç¬¦ä¸²ä¸­å¿…é¡»ç”¨ \\n è¡¨ç¤ºæ¢è¡Œï¼Œä¸è¦ä½¿ç”¨å®é™…æ¢è¡Œç¬¦"""

    # ã€æ·±åº¦æ¼”ç»æ¨¡å¼ã€‘User Prompt - æ•°æ®æ³¨å…¥
    user_content = f"""å½“å‰çƒ­é—¨é€‰é¢˜ä¿¡æ¯å¦‚ä¸‹ï¼š
- æ¥æºå¹³å°ï¼š{source}
- åŸå§‹æ ‡é¢˜ï¼š{original_title}
- ç«çˆ†åŸå› ï¼š{why_hot}
- æ ¸å¿ƒæ‘˜è¦ï¼š{summary}
- å‚è€ƒå¤§çº²ï¼š
{outline_text}

{reference_section}
è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼ŒæŒ‰ç…§ System Prompt ä¸­çš„ã€æ·±åº¦æ‰©å……æ³•åˆ™ã€‘ï¼Œå°†è¿™ç¯‡ç¬”è®°æ‰©å†™è‡³ 800 å­—ä»¥ä¸Šã€‚
å“ªæ€•å¤§çº²åªæœ‰ä¸€å¥è¯ï¼Œä½ ä¹Ÿè¦é€šè¿‡ä¸¾ä¾‹ã€è®²æ•…äº‹ã€åˆ—æ­¥éª¤ï¼Œå°†å…¶ä¸°å¯Œæˆä¸€æ®µæœ‰è¡€æœ‰è‚‰çš„å†…å®¹ã€‚
åªè¾“å‡º JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""

    return _call_llm_and_parse(system_prompt, user_content, topic, persona, model_name, temperature)


def generate_video_script(topic: str, persona: str = None, reference_text: str = None, model_name: str = "deepseek/deepseek-chat", temperature: float = 0.8) -> dict:
    """
    ã€è§†é¢‘æ¨¡å¼ã€‘ç”Ÿæˆæ·±åº¦è§†é¢‘è„šæœ¬ï¼ˆå£æ’­æ–‡ç¨¿ + åˆ†é•œç”»é¢ + æƒ…æ„Ÿåˆ†æï¼‰
    
    é‡‡ç”¨"ä¸­è§†é¢‘"ç­–ç•¥ï¼šæ—¶é•¿ä¸é™ï¼Œä»¥æŠŠé€»è¾‘è®²æ¸…æ¥šä¸ºæœ€é«˜ä¼˜å…ˆçº§ã€‚
    ä½¿ç”¨é«˜é¢‘åˆ†é•œé˜²æ­¢è§†è§‰ç–²åŠ³ï¼Œæ¯æ®µè§£è¯´è¯ 20-40 å­—ã€‚
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹ï¼ˆç”¨äºä»¿å†™ï¼‰
    
    Returns:
        {
            'titles': [...],           # 5ä¸ªå¤‡é€‰æ ‡é¢˜
            'content': '...',          # è§†é¢‘ç®€ä»‹ï¼ˆ200-300å­—ï¼‰
            'visual_scenes': [         # åˆ†é•œåˆ—è¡¨ï¼ˆ20-50ä¸ªï¼Œé«˜é¢‘åˆ†é•œï¼‰
                {
                    'scene_index': 1,
                    'narration': 'è¯¥åˆ†é•œå¯¹åº”çš„å£æ’­è§£è¯´è¯ï¼ˆ20-40å­—ï¼‰',
                    'description': 'ä¸­æ–‡ç”»é¢æè¿°',
                    'sentiment': 'æƒ…æ„ŸåŸºè°ƒ',
                    'prompt': 'çº¯ç”»é¢æè¿°ï¼ˆä¸å«é£æ ¼è¯ï¼‰'
                },
                ...
            ]
        }
    """
    reference_section = ""
    if reference_text:
        reference_section = f"""
å‚è€ƒå†…å®¹ï¼ˆè¯·ä»¿å†™å…¶ç»“æ„å’Œé£æ ¼ï¼‰ï¼š
---
{reference_text}
---
"""

    system_prompt = f"""ä½ æ˜¯**é¡¶çº§çºªå½•ç‰‡å¯¼æ¼”**ï¼ŒåŒæ—¶ç²¾é€š AI ç»˜å›¾æç¤ºè¯å·¥ç¨‹å’Œæƒ…æ„Ÿåˆ†æã€‚
ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯å°†"æ–‡æ¡ˆ"ç¿»è¯‘æˆ"è§†è§‰ç”»é¢"ï¼Œå¹¶å‡†ç¡®åˆ¤æ–­æ¯æ®µå†…å®¹çš„æƒ…æ„ŸåŸºè°ƒã€‚
ä½ çš„é£æ ¼æ˜¯ï¼š{persona or 'é€šç”¨åšä¸»'}

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
åŸºäºç”¨æˆ·ç»™å®šçš„é€‰é¢˜åˆ›ä½œä¸€ä¸ª**æ·±åº¦è§£æè§†é¢‘è„šæœ¬**ï¼ŒåŒ…å«è§†é¢‘ç®€ä»‹å’Œé«˜é¢‘åˆ†é•œè„šæœ¬ã€‚
**æ—¶é•¿ä¸é™**ï¼Œä»¥æŠŠé€»è¾‘è®²æ¸…æ¥šã€æŠŠå¹²è´§è®²é€å½»ä¸º**æœ€é«˜ä¼˜å…ˆçº§**ã€‚

ã€æ·±åº¦è§†é¢‘åˆ›ä½œåŸåˆ™ã€‘
1. **å®å¤šå‹¿é•¿**ï¼šä¸è¦è®©ä¸€å¼ å›¾ç‰‡åœç•™è¶…è¿‡ 8 ç§’ã€‚å¦‚æœè§£è¯´è¯å¾ˆé•¿ï¼Œå¿…é¡»åˆ‡åˆ†æˆå¤šä¸ªç”»é¢æ¥è¡¨è¾¾ã€‚
2. **é€»è¾‘å¯è§†åŒ–**ï¼šå½“è§£è¯´è¯åœ¨è®²"åŸç†"æ—¶ï¼Œç”»é¢è¦ç”»"æµç¨‹å›¾"æˆ–"ç¤ºæ„å›¾"ï¼›å½“è®²"æ¡ˆä¾‹"æ—¶ï¼Œç”»é¢è¦ç”»"åœºæ™¯å›¾"ã€‚
3. **å†…å®¹ä¸ºç‹**ï¼šä¸éœ€è¦ä¸ºäº†å‡‘æ—¶é—´è¯´åºŸè¯ï¼Œä½†å¿…é¡»æŠŠæ ¸å¿ƒå¹²è´§çš„ Why å’Œ How è§£é‡Šå¾—è¿å°å­¦ç”Ÿéƒ½èƒ½å¬æ‡‚ã€‚

ã€è§†é¢‘ç®€ä»‹è¦æ±‚ã€‘
1. å­—æ•°ç›®æ ‡ï¼š200-300æ±‰å­—
2. å†…å®¹ï¼šè§†é¢‘ä¸»é¢˜æ¦‚è¿°ï¼Œè¯´æ˜è§‚ä¼—èƒ½å­¦åˆ°ä»€ä¹ˆ
3. é£æ ¼ï¼šæœ‰æ·±åº¦ã€æœ‰å¸å¼•åŠ›ã€å¸¦emoji

ã€åˆ†é•œè„šæœ¬è¦æ±‚ - é«˜é¢‘åˆ†é•œç­–ç•¥ã€‘
ä½ éœ€è¦åƒ**ç”µå½±å¯¼æ¼”**ä¸€æ ·ï¼ŒæŠŠå†…å®¹æ‹†è§£ä¸º **20-50 ä¸ªé«˜é¢‘åˆ†é•œ**ã€‚
æ ¸å¿ƒåŸåˆ™ï¼šè®²å®Œä¸€ä¸ªçŸ¥è¯†ç‚¹æˆ–æ¢æ°”æ—¶ï¼Œå¿…é¡»åˆ‡æ¢ä¸‹ä¸€ä¸ªåˆ†é•œã€‚

1. narrationï¼ˆå£æ’­è§£è¯´è¯ï¼‰- **é«˜é¢‘åˆ‡æ¢åŸåˆ™**ï¼š
   - æ¯æ®µæ§åˆ¶åœ¨ **20-40 ä¸ªæ±‰å­—**ï¼ˆçº¦ 5-8 ç§’ï¼‰
   - å¿…é¡»**å®Œå…¨å£è¯­åŒ–**ï¼Œåƒåšä¸»åœ¨é¢å¯¹é¢èŠå¤©
   - å¤šç”¨è¿æ¥è¯ï¼š"å¤§å®¶çœ‹"ã€"æ³¨æ„è¿™é‡Œ"ã€"ä¹‹æ‰€ä»¥è¿™ä¹ˆåš"ã€"æ¢å¥è¯è¯´"ã€"ä¸¾ä¸ªä¾‹å­"
   - æ‰€æœ‰åˆ†é•œçš„ narration è¿èµ·æ¥ï¼Œæ˜¯ä¸€æ®µå®Œæ•´æµç•…çš„è§†é¢‘è§£è¯´è¯
   
   **é”™è¯¯ç¤ºèŒƒ**ï¼šä¸€ä¸ªåˆ†é•œåŒ…å«"è¿™é‡Œæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ­¥æ˜¯...ç¬¬äºŒæ­¥æ˜¯...ç¬¬ä¸‰æ­¥æ˜¯..."ï¼ˆâŒ å¤ªé•¿ï¼Œåº”è¯¥æ‹†æˆå¤šä¸ªåˆ†é•œï¼‰
   **æ­£ç¡®ç¤ºèŒƒ**ï¼š
   - åˆ†é•œ1ï¼š"è¿™é‡Œä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼Œæˆ‘ä¸€ä¸ªä¸€ä¸ªæ¥è®²ã€‚"
   - åˆ†é•œ2ï¼š"é¦–å…ˆæ˜¯ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°è®¾ç½®å…¥å£ã€‚"
   - åˆ†é•œ3ï¼š"å¤§å®¶æ³¨æ„çœ‹è¿™ä¸ªæŒ‰é’®ï¼Œç‚¹è¿›å»ä¹‹å..."
   
2. descriptionï¼ˆç”»é¢æè¿°ï¼‰ï¼š
   - ä¸­æ–‡æè¿°ç”»é¢ä¸»ä½“ã€åœºæ™¯ã€æ°›å›´
   
3. sentimentï¼ˆæƒ…æ„ŸåŸºè°ƒï¼‰- **å¿…é¡»ä»ä»¥ä¸‹5ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ª**ï¼š
   - "å¯çˆ±æ²»æ„ˆ"ï¼šæ¸©é¦¨ã€è½¯èŒã€æ²»æ„ˆç³»å†…å®¹
   - "ä¸¥è‚ƒæ·±åº¦"ï¼šæ·±åˆ»ã€ä¸“ä¸šã€çŸ¥è¯†å‹å†…å®¹
   - "æ—¥å¸¸ç”Ÿæ´»"ï¼šå¹³å¸¸ã€è‡ªç„¶ã€slice of life
   - "çƒ­è¡€åŠ±å¿—"ï¼šæ¿€åŠ±ã€å¥‹æ–—ã€æ­£èƒ½é‡
   - "æ‚²ä¼¤ä½æ²‰"ï¼šä¼¤æ„Ÿã€æ„Ÿæ…¨ã€æ€€æ—§
   
4. promptï¼ˆç”Ÿå›¾æç¤ºè¯ï¼‰- **ä¸­æ–‡çº¯å‡€ç”»é¢æè¿°**ï¼š
   - **å¿…é¡»ä½¿ç”¨ä¸­æ–‡**æè¿°ç”»é¢ï¼ˆè±†åŒ…æ¨¡å‹å¯¹ä¸­æ–‡ç†è§£æœ€å¥½ï¼‰
   - åªæè¿°ç”»é¢å†…å®¹ï¼šä¸»ä½“ + åŠ¨ä½œ + åœºæ™¯ + å…‰å½±
   - **ä¸¥ç¦å‡ºç°ä»»ä½•æ–‡å­—å…ƒç´ **ï¼šä¸è¦æå†™æ‹›ç‰Œã€å¯¹è¯æ¡†ã€å­—å¹•ã€logoã€æ°´å°
   - **ç¦æ­¢æ·»åŠ é£æ ¼è¯**ï¼ˆå¦‚ åŠ¨æ¼«é£æ ¼, 4k, é«˜æ¸… ç­‰ï¼‰ï¼Œé£æ ¼ç”±ç”»å®¶æ¨¡å—æ·»åŠ 
   - ç”»é¢è¦å¹²å‡€ã€æ„å›¾é«˜çº§

ã€è§†è§‰ç¿»è¯‘å…¬å¼ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘
æ ¹æ® narration å†…å®¹ç±»å‹ï¼Œè®¾è®¡ä¸­æ–‡çº¯å‡€ç”»é¢æè¿°çš„ promptï¼š

1. **å…·ä½“äº‹ç‰©**ï¼ˆå¦‚ï¼šå¤šåƒè‹¹æœï¼‰
   -> ç”»å…·è±¡ç‰©ä½“ï¼šä¸€é¢—çº¢è‹¹æœç‰¹å†™ï¼Œè¡¨é¢å¸¦æ°´ç ï¼ŒæŸ”å’Œè‡ªç„¶å…‰
   
2. **æŠ½è±¡æ¦‚å¿µ**ï¼ˆå¦‚ï¼šèŒåœºå‹åŠ›å¤§ã€åšæŒé•¿æœŸä¸»ä¹‰ï¼‰
   -> ç”»å…·è±¡éšå–»ï¼šç™»å±±è€…åœ¨é›ªå±±é¡¶å³°æ’æ——ï¼Œé€†å…‰å‰ªå½±ï¼Œé‡‘è‰²æ™šéœ
   -> æˆ–ï¼šç–²æƒ«çš„ä¸Šç­æ—åŒæ‰‹æŠ±å¤´ï¼Œç”µè„‘å±å¹•è“å…‰ç…§äº®é¢åºï¼Œæ·±å¤œåŠå…¬å®¤
   
3. **æµç¨‹æ­¥éª¤**ï¼ˆå¦‚ï¼šåˆ†ä¸‰æ­¥å®Œæˆï¼‰
   -> ç”»æµç¨‹å›¾ç¤ºï¼šä¸‰ä¸ªåœ†å½¢å›¾æ ‡æ’åˆ—ï¼Œç®­å¤´è¿æ¥ï¼Œç®€æ´ç¤ºæ„å›¾é£æ ¼
   
4. **æƒ…ç»ªè¡¨è¾¾**ï¼ˆå¦‚ï¼šå¤ªå¼€å¿ƒäº†ã€å¥½æ¿€åŠ¨ï¼‰
   -> ç”»è¡¨æƒ…ç‰¹å†™ï¼šå¹´è½»å¥³å­©ç¿çƒ‚ç¬‘å®¹ï¼Œé˜³å…‰æ´’è½ï¼Œæ¸©æš–æ°›å›´

**é”™è¯¯ç¤ºèŒƒ**ï¼šprompt "ä¸€ä¸ªäººåœ¨æ€è€ƒï¼Œç”»é¢æœ‰'åŠ æ²¹'æ–‡å­—"ï¼ˆâŒ ä¸è¦æœ‰æ–‡å­—å…ƒç´ ï¼‰
**æ­£ç¡®ç¤ºèŒƒ**ï¼šprompt "é©¬æ‹‰æ¾é€‰æ‰‹å†²è¿‡ç»ˆç‚¹çº¿ï¼Œæ—¥å‡ºèƒŒæ™¯ï¼Œèƒœåˆ©è¡¨æƒ…ï¼Œæš–è‰²è°ƒ"ï¼ˆâœ… ä¸­æ–‡çº¯å‡€ç”»é¢ï¼‰

ã€è¾“å‡ºæ ¼å¼ã€‘
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON ç»“æ„è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š

**é‡è¦**ï¼šå¯¹è¯å’Œå¼•ç”¨å¿…é¡»ä½¿ç”¨ä¸­æ–‡å¼•å·ã€Œã€ï¼Œç¦æ­¢ä½¿ç”¨è‹±æ–‡åŒå¼•å· "

{{
    "titles": ["æ ‡é¢˜1", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4", "æ ‡é¢˜5"],
    "content": "200-300å­—è§†é¢‘ç®€ä»‹ï¼Œå¸¦emojiï¼Œå¯¹è¯ç”¨ä¸­æ–‡å¼•å·ã€Œã€",
    "visual_scenes": [
        {{
            "scene_index": 1,
            "narration": "20-40å­—å£æ’­è¯ï¼ˆå£è¯­åŒ–ï¼ŒåƒèŠå¤©ï¼‰",
            "description": "ä¸­æ–‡ç”»é¢æè¿°ï¼šä¸»ä½“ã€åœºæ™¯ã€æ„Ÿè§‰",
            "sentiment": "å¯çˆ±æ²»æ„ˆ",
            "prompt": "ä¸­æ–‡çº¯å‡€ç”»é¢æè¿°ï¼ˆæ— æ–‡å­—å…ƒç´ ã€æ— é£æ ¼è¯ï¼‰"
        }},
        {{
            "scene_index": 2,
            "narration": "20-40å­—å£æ’­è¯",
            "description": "ä¸­æ–‡ç”»é¢æè¿°",
            "sentiment": "ä¸¥è‚ƒæ·±åº¦",
            "prompt": "ä¸­æ–‡å…·è±¡åŒ–ç”»é¢æè¿°"
        }}
    ]
}}

ã€å†™ä½œè§„åˆ™ã€‘
1. æ ‡é¢˜è¦æœ‰çˆ†æ¬¾æ½œåŠ›ï¼Œä½¿ç”¨æ•°å­—ã€ç–‘é—®å¥ã€æƒŠå¹å¥ç­‰å¸ç›æŠ€å·§
2. visual_scenes æ•°ç»„åŒ…å« **20-50 ä¸ªå…ƒç´ **ï¼Œæ ¹æ®å†…å®¹å¤æ‚åº¦çµæ´»è°ƒæ•´
3. JSON å­—ç¬¦ä¸²ä¸­å¿…é¡»ç”¨ \\n è¡¨ç¤ºæ¢è¡Œï¼Œä¸è¦ä½¿ç”¨å®é™…æ¢è¡Œç¬¦
4. åˆ†é•œçš„ narration è¿èµ·æ¥è¦æœ‰é€»è¾‘æ€§ï¼Œåƒä¸€ä¸ªå®Œæ•´çš„æ·±åº¦è®²è§£è§†é¢‘
5. æ¯ä¸ª prompt å¿…é¡»æ˜¯ä¸­æ–‡ï¼Œæè¿°çº¯å‡€ç”»é¢ï¼Œ**ç»å¯¹ä¸èƒ½æœ‰ä»»ä½•æ–‡å­—/æ‹›ç‰Œ/logo**
6. sentiment å¿…é¡»ä»5ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ï¼Œæ ¹æ®è¯¥æ®µ narration çš„æƒ…æ„Ÿæ°›å›´åˆ¤æ–­
7. **å†…å®¹æ·±åº¦ä¼˜å…ˆ**ï¼šå®å¯å¤šå‡ ä¸ªåˆ†é•œæŠŠäº‹æƒ…è®²æ¸…æ¥šï¼Œä¹Ÿä¸è¦ä¸ºäº†çŸ­è€Œçœç•¥å…³é”®ä¿¡æ¯"""

    user_content = f"""é€‰é¢˜ï¼š{topic}
{reference_section}
è¯·åˆ›ä½œæ·±åº¦è§£æè§†é¢‘è„šæœ¬ï¼ˆæ—¶é•¿ä¸é™ï¼ŒæŠŠé€»è¾‘è®²æ¸…æ¥šä¸ºç¬¬ä¸€ä¼˜å…ˆçº§ï¼‰ã€‚åªè¾“å‡º JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""

    return _call_llm_and_parse(system_prompt, user_content, topic, persona, model_name, temperature)


def generate_wechat_article(topic: str, persona: str = None, reference_text: str = None, model_name: str = "deepseek/deepseek-chat", search_data: dict = None, temperature: float = 0.8) -> dict:
    """
    ã€å…¬ä¼—å·æ¨¡å¼ã€‘ç”Ÿæˆæ·±åº¦é•¿æ–‡ + æ¶æ„å›¾/ç¤ºæ„å›¾
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: æŠ€æœ¯åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹ï¼ˆç”¨äºä»¿å†™ï¼‰
        model_name: OpenRouter æ¨¡å‹ ID
        search_data: websearch è¿”å›çš„å®Œæ•´çƒ­ç‚¹æ•°æ®
        temperature: LLM æ¸©åº¦å‚æ•°
    
    Returns:
        {
            'titles': [...],           # 5ä¸ªå¤‡é€‰æ ‡é¢˜
            'content': '...',          # æ·±åº¦é•¿æ–‡ï¼ˆä¸é™å­—æ•°ï¼Œå»ºè®®2000-5000å­—ï¼‰
            'diagrams': [              # æ¶æ„å›¾/ç¤ºæ„å›¾è®¾è®¡ï¼ˆ2-4å¼ ï¼‰
                {
                    'index': 1,
                    'title': 'æ¶æ„å›¾æ ‡é¢˜',
                    'description': 'ä¸­æ–‡æè¿°è¯¥å›¾è¡¨è¾¾çš„æŠ€æœ¯æ¶æ„',
                    'diagram_type': 'architecture' | 'flow' | 'comparison',
                    'prompt': 'ç”Ÿå›¾æç¤ºè¯ï¼ˆæå®¢ç¾å­¦ï¼‰'
                },
                ...
            ]
        }
    """
    reference_section = ""
    if reference_text:
        reference_section = f"""
å‚è€ƒå†…å®¹ï¼ˆè¯·ä»¿å†™å…¶ç»“æ„å’Œé£æ ¼ï¼‰ï¼š
---
{reference_text}
---
"""

    # è§£æ search_data
    search_data = search_data or {}
    source = search_data.get('source', 'æœªçŸ¥æ¥æº')
    original_title = search_data.get('title', topic)
    why_hot = search_data.get('why_hot', '')
    summary = search_data.get('summary', '')
    outline = search_data.get('outline', [])
    
    # æ ¼å¼åŒ–å¤§çº²
    outline_text = ""
    if outline and len(outline) > 0:
        outline_text = json.dumps(outline, indent=2, ensure_ascii=False)

    system_prompt = f"""ä½ æ˜¯{persona or 'æŠ€æœ¯åšä¸»'}ï¼Œä¸“æ³¨äºæ·±åº¦æŠ€æœ¯å†…å®¹åˆ›ä½œã€‚
ä½ ç°åœ¨è¦ä¸ºå¾®ä¿¡å…¬ä¼—å·åˆ›ä½œä¸€ç¯‡**æ·±åº¦æŠ€æœ¯é•¿æ–‡**ï¼Œå­—æ•°ä¸é™ï¼Œä»¥æŠŠæŠ€æœ¯è®²é€ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§ã€‚

ã€æ ¸å¿ƒè¦æ±‚ã€‘
1. **æ·±åº¦ä¼˜å…ˆ**ï¼šå¿…é¡»ç¬¦åˆ'é‡‘å­—å¡”åŸç†'ï¼Œç»“æ„ä¸ºï¼šèƒŒæ™¯/ç—›ç‚¹ â†’ ç°æœ‰æ–¹æ¡ˆå±€é™ â†’ æ·±åº¦åŸç†æ‹†è§£ â†’ æ¶æ„è®¾è®¡/ä»£ç æ€è·¯ â†’ å•†ä¸š/æœªæ¥ä»·å€¼
2. **å·¥ç¨‹è§†è§’**ï¼šä¸ä»…è®²ç®—æ³•åŸç†ï¼Œè¿˜è¦è®²éƒ¨ç½²ã€æˆæœ¬ã€å»¶è¿Ÿä¼˜åŒ–ã€å·¥ç¨‹å–èˆ
3. **å¯¹æ¯”åˆ†æ**ï¼šå¿…é¡»æœ‰ Pros & Cons å¯¹æ¯”ï¼Œæˆ–æŠ€æœ¯æ–¹æ¡ˆ A vs B çš„æ¨ªå‘å¯¹æ¯”
4. **é€šä¿—åŒ–è¡¨è¾¾**ï¼šç”¨ç±»æ¯”å’Œæ—¥å¸¸ä¾‹å­è§£é‡Šå¤æ‚æ¦‚å¿µï¼ˆå¦‚ï¼šç”¨'ä¼ è¯æ¸¸æˆ'è§£é‡ŠTransformerçš„Self-Attentionæœºåˆ¶ï¼‰

ã€æ–‡ç« ç»“æ„è¦æ±‚ã€‘
1. **æ ‡é¢˜**ï¼šç¡¬æ ¸ä¸”å¸å¼•äººï¼Œå¿…é¡»åŒ…å«æŠ€æœ¯å…³é”®è¯ã€‚ç¤ºä¾‹ï¼šã€ŠRAGå·²æ­»ï¼Ÿæ·±åº¦è§£æLong Contextçš„å·¥ç¨‹è¾¹ç•Œã€‹
2. **æ­£æ–‡**ï¼š
   - å¼€å¤´ï¼šæŠ›å‡ºæŠ€æœ¯ç—›ç‚¹æˆ–åç›´è§‰è§‚ç‚¹
   - ä¸­é—´ï¼šåˆ†å±‚é€’è¿›æ‹†è§£ï¼ˆWhy â†’ What â†’ Howï¼‰
   - ç»“å°¾ï¼šæ€»ç»“æŠ€æœ¯ä»·å€¼å’Œæœªæ¥å±•æœ›
   - **ä»£ç å¤„ç†**ï¼šå¯ä»¥ç”¨æ–‡å­—æè¿°ä»£ç é€»è¾‘ï¼Œä¸è¦è¾“å‡ºå®é™…ä»£ç å—
3. **æ’ç‰ˆ**ï¼šä½¿ç”¨å°æ ‡é¢˜ï¼ˆäºŒçº§æ ‡é¢˜ ##ï¼‰åˆ†æ®µï¼Œå…³é”®æ¦‚å¿µ**åŠ ç²—**

ã€æ¶æ„å›¾è®¾è®¡è¦æ±‚ã€‘
å¿…é¡»è®¾è®¡ 2-4 å¼ æ¶æ„å›¾/ç¤ºæ„å›¾ï¼Œç”¨äºå¯è§†åŒ–æŠ€æœ¯æ¶æ„ã€‚

æ¯å¼ å›¾éœ€åŒ…å«ï¼š
1. titleï¼šå›¾è¡¨æ ‡é¢˜ï¼ˆå¦‚ï¼š"RAGæ¶æ„å¯¹æ¯”"ï¼‰
2. descriptionï¼šä¸­æ–‡æè¿°è¯¥å›¾è¡¨è¾¾çš„æŠ€æœ¯æ¦‚å¿µã€ç»„ä»¶å…³ç³»
3. diagram_typeï¼šå›¾è¡¨ç±»å‹
   - "architecture"ï¼šç³»ç»Ÿæ¶æ„å›¾ï¼ˆç»„ä»¶ã€æ¨¡å—ã€æ•°æ®æµï¼‰
   - "flow"ï¼šæµç¨‹å›¾ï¼ˆæ­¥éª¤ã€å†³ç­–æ ‘ã€æ—¶åºï¼‰
   - "comparison"ï¼šå¯¹æ¯”å›¾ï¼ˆæ–¹æ¡ˆA vs Bï¼Œä¼˜ç¼ºç‚¹å¯¹æ¯”ï¼‰
4. promptï¼šç”Ÿå›¾æç¤ºè¯ï¼ˆæå®¢ç¾å­¦é£æ ¼ï¼‰
   - å¿…é¡»åŒ…å«ï¼šcyberpunk style, dark background, neon accents
   - æè¿°å…·ä½“çš„æŠ€æœ¯ç»„ä»¶ã€è¿æ¥å…³ç³»ã€æ•°æ®æµå‘
   - ç¤ºä¾‹ï¼š"cyberpunk system architecture, RAG pipeline with vector database, embedding model, and LLM, glowing data connections, dark blue background, neon highlights"

ã€è¾“å‡ºæ ¼å¼ - ä¸¥æ ¼éµå®ˆã€‘
**é‡è¦**ï¼šå¿…é¡»ä¸”åªèƒ½è¾“å‡ºçº¯ JSON å¯¹è±¡ï¼Œä¸è¦ç”¨ ```json åŒ…è£¹ï¼Œä¸è¦è¾“å‡ºä»»ä½•ä»£ç å—ã€‚

**JSON è§„èŒƒ**ï¼šå¯¹è¯å’Œå¼•ç”¨å¿…é¡»ä½¿ç”¨ä¸­æ–‡å¼•å·ã€Œã€ï¼Œç¦æ­¢ä½¿ç”¨è‹±æ–‡åŒå¼•å· "
ç¤ºä¾‹ï¼šâŒ "è€æ¿è¯´ï¼š"åŠ æ²¹""  âœ… "è€æ¿è¯´ï¼šã€ŒåŠ æ²¹ã€"

è¾“å‡ºæ ¼å¼ï¼š
{{
    "titles": ["æ ‡é¢˜1ï¼ˆå¿…é¡»åŒ…å«æŠ€æœ¯å…³é”®è¯ï¼‰", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4", "æ ‡é¢˜5"],
    "content": "æ·±åº¦æŠ€æœ¯é•¿æ–‡ï¼Œä¸é™å­—æ•°ï¼Œå»ºè®®2000-5000å­—ï¼Œç”¨\\nè¡¨ç¤ºæ¢è¡Œï¼Œ**å…³é”®æ¦‚å¿µ**ç”¨markdownåŠ ç²—ï¼Œå¯¹è¯ç”¨ä¸­æ–‡å¼•å·ã€Œã€ã€‚å¯ä»¥åœ¨æ–‡å­—ä¸­æè¿°ä»£ç é€»è¾‘ï¼Œä½†ä¸è¦è¾“å‡ºå®é™…çš„ ```python ä»£ç å—ã€‚",
    "diagrams": [
        {{
            "index": 1,
            "title": "æ¶æ„å›¾æ ‡é¢˜",
            "description": "ä¸­æ–‡æè¿°è¯¥å›¾è¡¨è¾¾çš„æŠ€æœ¯æ¶æ„å’Œç»„ä»¶å…³ç³»",
            "diagram_type": "architecture",
            "prompt": "cyberpunk style system architecture, å…·ä½“ç»„ä»¶æè¿°, dark background, neon accents"
        }}
    ]
}}

**é”™è¯¯ç¤ºèŒƒ**ï¼ˆç»å¯¹ç¦æ­¢ï¼‰ï¼š
```json
{{...}}
```
æˆ–è€…è¾“å‡ºä»£ç å—ï¼š
```python
ä»£ç ...
```

**æ­£ç¡®ç¤ºèŒƒ**ï¼š
ç›´æ¥è¾“å‡º {{"titles": [...], "content": "...", "diagrams": [...]}}

ã€å†™ä½œè§„åˆ™ã€‘
1. æ ‡é¢˜è¦æœ‰æŠ€æœ¯æ·±åº¦å’Œå¸å¼•åŠ›ï¼Œé¿å…æ ‡é¢˜å…š
2. æ­£æ–‡å¿…é¡»æ·±åº¦è¯¦å®ï¼Œ**å»ºè®®2000-5000å­—**ï¼ŒæŠŠæŠ€æœ¯è®²é€
3. diagrams æ•°ç»„åŒ…å« 2-4 ä¸ªå…ƒç´ 
4. æ¯ä¸ª diagram çš„ prompt å¿…é¡»ç¬¦åˆæå®¢ç¾å­¦ï¼šæ·±è‰²èƒŒæ™¯ã€éœ“è™¹è‰²ã€èµ›åšæœ‹å…‹é£æ ¼
5. JSON å­—ç¬¦ä¸²ä¸­å¿…é¡»ç”¨ \\n è¡¨ç¤ºæ¢è¡Œï¼Œä¸è¦ä½¿ç”¨å®é™…æ¢è¡Œç¬¦
6. **ç»å¯¹ç¦æ­¢**ï¼šä¸è¦è¾“å‡º ```jsonã€```python ç­‰ä»£ç å—ï¼Œç›´æ¥è¾“å‡ºçº¯ JSON å¯¹è±¡"""

    user_content = f"""å½“å‰æŠ€æœ¯é€‰é¢˜ä¿¡æ¯å¦‚ä¸‹ï¼š
- æ¥æºå¹³å°ï¼š{source}
- åŸå§‹æ ‡é¢˜ï¼š{original_title}
- ç«çˆ†åŸå› ï¼š{why_hot}
- æ ¸å¿ƒæ‘˜è¦ï¼š{summary}
- å‚è€ƒå¤§çº²ï¼š
{outline_text}

{reference_section}
è¯·åˆ›ä½œä¸€ç¯‡å¾®ä¿¡å…¬ä¼—å·æ·±åº¦æŠ€æœ¯æ–‡ç« ï¼ŒæŠŠè¿™ä¸ªæŠ€æœ¯è¯é¢˜è®²é€å½»ã€‚

**é‡è¦æé†’**ï¼š
1. ç›´æ¥è¾“å‡º JSON å¯¹è±¡ï¼Œä¸è¦ç”¨ ```json åŒ…è£¹
2. ä¸è¦è¾“å‡ºä»»ä½•ä»£ç å—ï¼ˆ```pythonã€```yaml ç­‰ï¼‰
3. ä»£ç é€»è¾‘ç”¨æ–‡å­—æè¿°å³å¯
4. åªè¾“å‡ºçº¯ JSONï¼Œæ ¼å¼å¦‚ï¼š{{"titles": [...], "content": "...", "diagrams": [...]}}"""

    return _call_llm_and_parse(system_prompt, user_content, topic, persona, model_name, temperature)


def generate_note_package(topic: str, persona: str = None, reference_text: str = None, mode: str = "image", model_name: str = "deepseek/deepseek-chat", search_data: dict = None, temperature: float = 0.8) -> dict:
    """
    ç»Ÿä¸€å…¥å£ï¼šæ ¹æ®æ¨¡å¼ç”Ÿæˆå†…å®¹
    
    Args:
        topic: é€‰é¢˜/ä¸»é¢˜
        persona: åšä¸»äººè®¾é£æ ¼æè¿°
        reference_text: å‚è€ƒå†…å®¹
        mode: "image"ï¼ˆå›¾æ–‡æ¨¡å¼ï¼‰ã€"video"ï¼ˆè§†é¢‘æ¨¡å¼ï¼‰æˆ– "wechat"ï¼ˆå…¬ä¼—å·æ¨¡å¼ï¼‰
        model_name: OpenRouter æ¨¡å‹ ID
        search_data: websearch è¿”å›çš„å®Œæ•´çƒ­ç‚¹æ•°æ®
    
    Returns:
        å¯¹åº”æ¨¡å¼çš„å†…å®¹ç»“æ„
    """
    if mode == "video":
        return generate_video_script(topic, persona, reference_text, model_name, temperature)
    elif mode == "wechat":
        return generate_wechat_article(topic, persona, reference_text, model_name, search_data, temperature)
    else:
        return generate_image_note(topic, persona, reference_text, model_name, search_data, temperature)


def generate_note_package_with_retry(
    topic: str,
    persona: str = None,
    reference_text: str = None,
    mode: str = "image",
    model_name: str = "deepseek/deepseek-chat",
    search_data: dict = None,
    temperature: float = 0.8,
    max_retries: int = 2,
    quality_threshold: int = 70
) -> dict:
    """
    å¸¦è´¨é‡æ£€æµ‹çš„ç”Ÿæˆå‡½æ•°
    
    å¦‚æœç”Ÿæˆçš„å†…å®¹è´¨é‡ä¸è¾¾æ ‡ï¼Œä¼šè‡ªåŠ¨é‡è¯•ï¼ˆé™ä½ temperature æå‡ç¨³å®šæ€§ï¼‰
    
    Args:
        max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
        quality_threshold: è´¨é‡åˆ†æ•°é˜ˆå€¼ï¼ˆ0-100ï¼‰
        å…¶ä»–å‚æ•°åŒ generate_note_package
    
    Returns:
        ç”Ÿæˆç»“æœï¼ˆåŒ generate_note_packageï¼‰
    """
    current_temp = temperature
    
    for attempt in range(max_retries + 1):
        print(f"[Writer] ç”Ÿæˆå°è¯• {attempt + 1}/{max_retries + 1}ï¼Œtemperature={current_temp:.2f}")
        
        result = generate_note_package(
            topic=topic,
            persona=persona,
            reference_text=reference_text,
            mode=mode,
            model_name=model_name,
            search_data=search_data,
            temperature=current_temp
        )
        
        # åªæ£€æµ‹å›¾æ–‡æ¨¡å¼çš„æ­£æ–‡è´¨é‡ï¼ˆè§†é¢‘å’Œå…¬ä¼—å·æ¨¡å¼è·³è¿‡ï¼‰
        if mode == "image" and result.get("content"):
            quality = check_content_quality(result["content"])
            print(f"[Quality] è¯„åˆ†: {quality['score']}/100")
            
            if quality["is_acceptable"]:
                print("[Quality] âœ… è´¨é‡åˆæ ¼")
                return result
            
            if attempt < max_retries:
                print(f"[Quality] âŒ è´¨é‡ä¸è¾¾æ ‡ ({quality['score']}åˆ† < {quality_threshold}åˆ†)")
                print(f"[Quality] é—®é¢˜: {', '.join(quality['issues'])}")
                print(f"[Quality] å‡†å¤‡é‡è¯•...")
                # é™ä½ temperature æå‡ç¨³å®šæ€§
                current_temp = max(0.5, current_temp - 0.15)
            else:
                print(f"[Quality] âš ï¸ å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¿”å›å½“å‰ç»“æœ")
                print(format_quality_report(quality))
        else:
            # è§†é¢‘æ¨¡å¼æˆ–æ— å†…å®¹ï¼Œç›´æ¥è¿”å›
            return result
    
    return result
